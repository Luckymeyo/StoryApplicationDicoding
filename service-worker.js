const CACHE_NAME="story-app-shell-v1",URLS_TO_CACHE=["/","/index.html","/offline.html","/favicon.png","/manifest.json","/images/icon-192.png","/images/icon-512.png","/app.bundle.js","/app.css"];self.addEventListener("install",(e=>{e.waitUntil(caches.open(CACHE_NAME).then((e=>e.addAll(URLS_TO_CACHE))).catch((e=>console.error("SW install cache failed:",e)))),self.skipWaiting()})),self.addEventListener("activate",(e=>{e.waitUntil(caches.keys().then((e=>Promise.all(e.filter((e=>e!==CACHE_NAME)).map((e=>caches.delete(e))))))),self.clients.claim()})),self.addEventListener("fetch",(e=>{const{request:t}=e,a=new URL(t.url);"navigate"!==t.mode?a.origin===location.origin||t.url.includes("story-api.dicoding.dev")?e.respondWith(fetch(t).then((e=>e)).catch((()=>caches.match(t).then((e=>e||new Response("Resource unavailable offline",{status:504,statusText:"Offline",headers:{"Content-Type":"text/plain"}})))))):e.respondWith(caches.match(t).then((e=>e||fetch(t).catch((()=>new Response("Network error",{status:502,statusText:"Bad Gateway",headers:{"Content-Type":"text/plain"}})))))):e.respondWith(fetch(t).catch((()=>caches.match("/offline.html").then((e=>e||new Response("Offline Page Not Available",{status:503,statusText:"Offline",headers:{"Content-Type":"text/plain"}}))))))})),self.addEventListener("sync",(e=>{"outbox-sync"===e.tag&&e.waitUntil((async()=>{const{getOutboxItems:e,clearOutbox:t}=await import("./db.js"),a=await e();for(const{token:e,formData:t}of a)await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:"Bearer "+e},body:t});await t()})())})),self.addEventListener("push",(e=>{let t="Push Default Title",a={body:"Ini adalah isi notifikasi dari push DevTools.",icon:"/images/icon-192.png",badge:"/images/icon-192.png"};try{const n=e.data.json();t=n.title||t,a=n.options||a}catch(e){console.warn("Push tanpa data, fallback ke default.")}e.waitUntil(self.registration.showNotification(t,a))})),self.addEventListener("notificationclick",(e=>{e.notification.close(),e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>e[0]?.focus()||clients.openWindow("/"))))}));